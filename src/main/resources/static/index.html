<!doctype html>
<html>
<head>
  <title>Финансы</title>
  <link href="https://yastatic.net/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/restApi.js"></script>
  <script src="js/transaction.js"></script>
  <script src="js/rubric.js"></script>
  <script src="js/tag.js"></script>
  <script src="js/user.js"></script>
  <script src="js/account.js"></script>
  <style type="text/css">
    body {
      padding: 20px;
    }

    .ng-cloak {
      display: none;
    }

    tr th, td {
      width: 30px;
      text-align: center;
      border: 1px solid black;
    }
  </style>
</head>

<body ng-app="app" ng-cloak>
<div ng-controller="show-transactions">
  <h4>{{transactions.yearMonth}}</h4>
  <button ng-click="previousMonth()">Предыдущий месяц</button>
  <button ng-click="nextMonth()">Следующий месяц</button>
  <table>
    <tr>
      <th></th>
      <th ng-repeat="day in transactions.daysOfMonth">{{day}}</th>
      <th>Итого</th>
    </tr>
    <tr ng-repeat="rubric in transactions.rubrics | filter:filterIncomeRubrics | orderBy:'name'">
      <td>{{rubric.name}}</td>
      <td ng-repeat="day in transactions.daysOfMonth"
          ng-click="updateCellTransactions(rubric, day)">
        {{findRubricByDaySummary(rubric, day)}}
      </td>
      <td>{{findRubricSummary(rubric)}}</td>
    </tr>
    <tr>
      <td></td>
    </tr>
    <tr ng-repeat="rubric in transactions.rubrics | filter:filterExpenceRubrics | orderBy:'name'">
      <td>{{rubric.name}}</td>
      <td ng-repeat="day in transactions.daysOfMonth"
          ng-click="updateCellTransactions(rubric, day)">
        {{findRubricByDaySummary(rubric, day)}}
      </td>
      <td>{{findRubricSummary(rubric)}}</td>
    </tr>
    <tr>
      <td></td>
    </tr>
    <tr>
      <th>Итого</th>
      <td ng-repeat="day in transactions.daysOfMonth">{{findDaySummary(day)}}</td>
      <td>{{transactions.monthSummary}}</td>
    </tr>
  </table>
  <br/>
</div>

<div ng-controller="edit-transactions" ng-show="editor.show">
  <table>
    <tr>
      <th>Пользователь</th>
      <th>Тэг</th>
      <th>Сумма</th>
      <th>Комментарий</th>
      <th>Действие</th>
    </tr>
    <tr ng-repeat="t in editor.cellTransactions | orderBy:'id':true">
      <td>
        <select ng-model="t.user" ng-change="updateTransaction(t)"
                ng-options="user as user.name for user in editor.users track by user.id">
        </select>
      </td>
      <td>
        <select ng-model="t.tag" ng-change="updateTransaction(t)"
                ng-options="tag as tag.name for tag in editor.tags track by tag.id">
        </select>
      </td>
      <td>
        <input ng-model="t.amountFrom" type="number" min="1" required
               ng-change="updateTransaction(t)" ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input ng-model="t.comment" type="text" size="25" ng-change="updateTransaction(t)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input type="submit" value="Удалить" ng-click="deleteTransaction(t)">
      </td>
    </tr>
  </table>
  <div>{{log}}</div>
</div>

<div ng-controller="add-transaction">
  <h4>Добавить транзакцию</h4>
  <form ng-submit="addTransaction()">
    <table>
      <tr>
        <td>Дата:</td>
        <td>
          <input ng-model="newTransaction.dayRef" type="date" required title="YYYY-MM-DD"
                 pattern="[0-9]{4}-(0[1-9]|1[012])-(0[1-9]|1[0-9]|2[0-9]|3[01])">
        </td>
      </tr>
      <tr>
        <td><input type="radio" ng-model="type" value="income" ng-click='changeType(type)'> Доход
        </td>
        <td><input type="radio" ng-model="type" value="expense" ng-click='changeType(type)'> Расход
        </td>
      </tr>
      <tr>
        <td>Рубрика:</td>
        <td>
          <select ng-model="newTransaction.rubric" size="1" required
                  ng-options="rubric as rubric.name for rubric in rubrics | orderBy:'name' track by rubric.id">
          </select>
        </td>
      </tr>
      <tr>
        <td>Пользователь:</td>
        <td>
          <select ng-model="newTransaction.user" size="1"
                  ng-options="user as user.name for user in users | orderBy:'name' track by user.id">
          </select>
        </td>
      </tr>
      <tr>
        <td>Тэг:</td>
        <td>
          <select ng-model="newTransaction.tag" size="1"
                  ng-options="tag as tag.name for tag in tags | orderBy:'name' track by tag.id">
          </select>
        </td>
      </tr>
      <tr>
        <td>Сумма:</td>
        <td><input ng-model="newTransaction.amountFrom" type="number" min="1" required></td>
      </tr>
      <tr>
        <td>Комментарий:</td>
        <td><input ng-model="newTransaction.comment" type="text" size="25"></td>
      </tr>
      <tr>
        <td colspan="2"><input type="submit" value="Добавить"></td>
      </tr>
    </table>
  </form>
  <div>{{log}}</div>
</div>

<div ng-controller="show-rubrics">
  <h4>Рубрики</h4>
  <table>
    <tr>
      <th>Название</th>
      <th>Доход?</th>
      <th>Удалить</th>
    </tr>
    <tr ng-repeat="rubric in rubrics | orderBy:['isIncome','name']">
      <td>
        <input ng-model="rubric.name" type="text" size="25" ng-change="updateRubric(rubric)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input ng-model="rubric.isIncome" type="checkbox" disabled>
      </td>
      <td>
        <button ng-click="deleteRubric(rubric)" ng-disabled="rubric.hasTransactions">Удалить
        </button>
      </td>
    </tr>
  </table>
  <br>
  <form ng-submit="saveRubric({name:newRubric.name, isIncome:newRubric.isIncome})">
    Название:
    <input ng-model="newRubric.name" type="text" maxlength="25" required>

    Доход:
    <input ng-model="newRubric.isIncome" type="checkbox">
    <br>
    <button>Добавить</button>
  </form>
  {{log}}
</div>

<div ng-controller="tag">
  <h4>Тэги</h4>
  <table>
    <tr>
      <th>Название</th>
      <th>Удалить</th>
    </tr>
    <tr ng-repeat="tag in tags | orderBy:'name'">
      <td>
        <input ng-model="tag.name" type="text" size="25" ng-change="updateTag(tag)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <button ng-click="deleteTag(tag)" ng-disabled="tag.hasTransactions">Удалить</button>
      </td>
    </tr>
  </table>
  <br>
  <form ng-submit="saveTag({name:newTag.name})">
    Название: <input ng-model="newTag.name" type="text" maxlength="25" required>
    <button>Добавить</button>
  </form>
  {{log}}
</div>

<div ng-controller="user">
  <h4>Пользователи</h4>
  <table>
    <tr>
      <th>Название</th>
      <th>Удалить</th>
    </tr>
    <tr ng-repeat="user in users | orderBy:'name'">
      <td>
        <input ng-model="user.name" type="text" size="25" ng-change="updateUser(user)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <button ng-click="deleteUser(user)" ng-disabled="user.hasTransactions">Удалить</button>
      </td>
    </tr>
  </table>
  <br>
  <form ng-submit="saveUser({name:newUser.name})">
    Название: <input ng-model="newUser.name" type="text" maxlength="25" required>
    <button>Добавить</button>
  </form>
  {{log}}
</div>

<div ng-controller="show-accounts">
  <h4>Счета</h4>
  <table>
    <tr>
      <th>Название</th>
      <th>Валюта</th>
      <th>Баланс</th>
      <th>Транзакций</th>
      <th>Удалить</th>
    </tr>
    <tr ng-repeat="account in accounts | filter:{type:'!OUTER'} | orderBy:['type', 'name']">
      <td>
        <input ng-model="account.name" type="text" size="25" ng-change="updateAccount(account)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>{{account.currency.name}}({{account.currency.symbol}})</td>
      <td>{{account.balance}}</td>
      <td>{{account.amountTransactions}}</td>
      <td>
        <button ng-click="deleteAccount(account)" ng-disabled="account.hasTransactions">Удалить
        </button>
      </td>
    </tr>
  </table>
  {{log}}
  <br>
  <form ng-submit="saveAccount()">
    Название: <input ng-model="newAccount.name" type="text" maxlength="25" required>
    Валюта: <select ng-model="newAccount.currency"
                    ng-options="currency as currency.name for currency in currencies track by currency.id">
  </select>
    <button>Добавить</button>
  </form>
</div>

<div ng-controller="add-transfer">
  <h4>Добавить перевод</h4>
  <form ng-submit="addTransfer()">
    <table>
      <tr>
        <td>Дата:</td>
        <td>
          <input ng-model="newTransfer.dayRef" type="text" required title="YYYY-MM-DD"
                 pattern="[0-9]{4}-(0[1-9]|1[012])-(0[1-9]|1[0-9]|2[0-9]|3[01])">
        </td>
      </tr>
      <tr>
        <td>Счет 1:</td>
        <td>
          <select ng-model="newTransfer.accountFrom" ng-change="checkEquals()"
                  ng-options="account as account.name for account in accounts | orderBy:'name' | filter:{type:'!OUTER'}
                  track by account.id">
          </select>
        </td>
      </tr>
      <tr>
        <td>Счет 2:</td>
        <td>
          <select ng-model="newTransfer.accountTo" ng-change="checkEquals()"
                  ng-options="account as account.name for account in accounts | orderBy:'name' | filter:{type:'!OUTER'}
                  track by account.id">
          </select>
        </td>
      </tr>
      <tr>
        <td>Сумма 1:</td>
        <td><input ng-model="newTransfer.amountFrom" type="number" min="1" required></td>
      </tr>
      <tr>
        <td>Сумма 2:</td>
        <td><input ng-model="newTransfer.amountTo" type="number" min="1" required></td>
      </tr>
      <tr>
        <td>Комментарий:</td>
        <td><input ng-model="newTransfer.comment" type="text" size="25"></td>
      </tr>
      <tr>
        <td colspan="2"><input type="submit" value="Добавить"></td>
      </tr>
    </table>
  </form>
  <div>{{log}}</div>
  <br>
</div>

<div ng-controller="show-transfers">
  <table>
    <tr>
      <th>Счет 1</th>
      <th>Счет 2</th>
      <th>Сумма 1</th>
      <th>Сумма 2</th>
      <th>Комментарий</th>
      <th>Действие</th>
    </tr>
    <tr ng-repeat="t in transfers | orderBy:'id':true">
      <td>{{t.accountFrom.name}}({{t.accountFrom.currency.symbol}})</td>
      <td>{{t.accountTo.name}}({{t.accountTo.currency.symbol}})</td>
      <td>
        <input ng-model="t.amountFrom" type="number" min="1" required
               ng-change="updateTransaction(t)" ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input ng-model="t.amountTo" type="number" min="1" required
               ng-change="updateTransaction(t)" ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input ng-model="t.comment" type="text" size="25" ng-change="updateTransaction(t)"
               ng-model-options="{debounce: 2000}">
      </td>
      <td>
        <input type="submit" value="Удалить" ng-click="deleteTransfer(t)">
      </td>
    </tr>
  </table>
  <div>{{log}}</div>
</div>
</body>
</html>
