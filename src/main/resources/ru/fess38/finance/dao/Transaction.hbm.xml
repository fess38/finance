<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
  <class name="ru.fess38.finance.model.Transaction" table="${transactionTable}">
    <id name="id" column="id">
      <generator class="org.hibernate.id.enhanced.SequenceStyleGenerator">
        <param name="sequence_name">${sequence}</param>
      </generator>
    </id>
    <property name="amountFrom" column="amountFrom" />
    <property name="amountTo" column="amountTo" />
    <property name="dayRef" column="dayRef" />
    <property name="comment" column="comment" />
    <many-to-one name="accountFrom" class="ru.fess38.finance.model.Account" column="accountFromId" lazy="false" />
    <many-to-one name="accountTo" class="ru.fess38.finance.model.Account" column="accountToId" lazy="false" />
    <many-to-one name="rubric" class="ru.fess38.finance.model.Rubric" column="rubricId" lazy="false" />
    <many-to-one name="transactionGroup" class="ru.fess38.finance.model.TransactionGroup" column="transactionGroupId"
      lazy="false" />
    <many-to-one name="user" class="ru.fess38.finance.model.User" column="userId" lazy="false" />
    <sql-delete><![CDATA[ update ${transactionTable} set isDeleted = TRUE where id = :id ]]></sql-delete>
  </class>

  <query name="transactionFindAll">
    <![CDATA[ from Transaction where isDeleted = FALSE ]]>
  </query>

  <query name="transactionFindByYearMonth">
    <![CDATA[ from Transaction where YEAR(dayRef) = :year and MONTH(dayRef) = :month
    and isDeleted = FALSE and rubric.isService = FALSE ]]>
  </query>

  <sql-query name="isEntityUsed" read-only="true">
    <![CDATA[ SELECT COUNT(*)
    FROM (
      SELECT rubricId id
      FROM ${transactionTable}
      WHERE isDeleted = FALSE
      UNION ALL
      SELECT accountFromId
      FROM ${transactionTable}
      WHERE isDeleted = FALSE
      UNION ALL
      SELECT accountToId
      FROM ${transactionTable}
      WHERE isDeleted = FALSE
      UNION ALL
      SELECT userId
      FROM ${transactionTable}
      WHERE isDeleted = FALSE
      UNION ALL
      SELECT transactionGroupId
      FROM ${transactionTable}
      WHERE isDeleted = FALSE
      ) t
    WHERE t.id = :id ]]>
  </sql-query>
</hibernate-mapping>
